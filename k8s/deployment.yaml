---
# Shared AI Gateway - Node.js Express server that routes AI requests
# Provides fallback chain: Groq -> Local GPU -> Anthropic
#
# SECRET SETUP (run before applying this file):
# kubectl create secret generic ai-gateway-credentials \
#   --from-literal=GROQ_API_KEY=<your-groq-key> \
#   --from-literal=ANTHROPIC_API_KEY=<your-anthropic-key>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shared-ai-gateway
  labels:
    app: shared-ai-gateway
    component: ai-gateway
    portfolio: "true"
    tier: ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shared-ai-gateway
  template:
    metadata:
      labels:
        app: shared-ai-gateway
        component: ai-gateway
        portfolio: "true"
        tier: ai
    spec:
      initContainers:
        - name: wait-for-kafka
          image: busybox:1.37
          command: ['sh', '-c', 'until nc -z vertex-kafka-kafka-bootstrap.microservices.svc 9092; do echo "Waiting for Kafka..."; sleep 5; done']
      containers:
        - name: ai-gateway
          image: maxjeffwell/shared-ai-gateway:latest
          ports:
            - containerPort: 8002
              name: http
              protocol: TCP
          env:
            - name: PORT
              value: "8002"
            - name: BACKEND_PREFERENCE
              value: "auto"
            - name: GROQ_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ai-gateway-credentials
                  key: GROQ_API_KEY
            - name: GROQ_MODEL
              value: "llama-3.3-70b-versatile"
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ai-gateway-credentials
                  key: ANTHROPIC_API_KEY
            - name: ANTHROPIC_MODEL
              value: "claude-sonnet-4-20250514"
            - name: CACHE_ENABLED
              value: "true"
            - name: REDIS_URL
              value: "redis://:redis123@redis:6379"
            - name: LENS_LOOP_PROXY
              value: "https://lens-loop.el-jefe.me"
            - name: LITELLM_URL
              value: "https://litellm.el-jefe.me"
            - name: LENS_LOOP_PROJECT
              value: "lens-loop-project"
            - name: LOCAL_GPU_URL
              value: "https://gpu.el-jefe.me"
            - name: LOCAL_GPU_MODEL
              value: "llama3.2:3b-instruct-q4_K_M"
            - name: LOCAL_URL
              value: "http://llama-cpu-service:8080"
            - name: HF_MODEL
              value: "meta-llama/Llama-3.1-8B-Instruct"
            - name: RUNPOD_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ai-gateway-credentials
                  key: RUNPOD_API_KEY
            - name: RUNPOD_ENDPOINT_ID
              valueFrom:
                secretKeyRef:
                  name: ai-gateway-credentials
                  key: RUNPOD_ENDPOINT_ID
            - name: KAFKA_ENABLED
              value: "true"
            - name: KAFKA_BROKERS
              value: "vertex-kafka-kafka-bootstrap.microservices.svc:9092"
            - name: KAFKA_AI_EVENTS_TOPIC
              value: "ai.gateway.events"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: shared-ai-gateway
  labels:
    app: shared-ai-gateway
    component: ai-gateway
    tier: ai
spec:
  type: ClusterIP
  selector:
    app: shared-ai-gateway
  ports:
    - name: http
      port: 8002
      targetPort: 8002
      protocol: TCP
---
# Network policy to allow portfolio apps to reach AI gateway
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-apps-to-ai-gateway
  labels:
    app: shared-ai-gateway
    component: ai-gateway
    tier: ai
spec:
  podSelector:
    matchLabels:
      app: shared-ai-gateway
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              portfolio: "true"
      ports:
        - protocol: TCP
          port: 8002
